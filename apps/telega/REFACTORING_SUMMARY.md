# Telega Refactoring Summary

## –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

Telega –±—ã–ª –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω –∏–∑ —Å–µ—Ä–≤–∏—Å–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –≤ –ø—Ä–æ—Å—Ç–æ–π —Ñ–æ—Ä–≤–∞—Ä–¥–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π.

## –£–¥–∞–ª–µ–Ω–æ

### –§–∞–π–ª—ã

- ‚ùå `src/store.ts` - —Ä–∞–±–æ—Ç–∞ —Å PostgreSQL
- ‚ùå `src/parse.ts` - –ø–∞—Ä—Å–∏–Ω–≥ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤
- ‚ùå `CHANNELS_API.md` - —Å—Ç–∞—Ä–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- ‚ùå `MIGRATION_GUIDE.md` - —Å—Ç–∞—Ä–∞—è –º–∏–≥—Ä–∞—Ü–∏—è
- ‚ùå `API_QUICK_REFERENCE.md` - —Å—Ç–∞—Ä–∞—è —Å–ø—Ä–∞–≤–∫–∞

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

- ‚ùå `@aladdin/database` - –±–æ–ª—å—à–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ–º —Å –±–∞–∑–æ–π
- ‚ùå `node-telegram-bot-api` - –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

- ‚ùå `DATABASE_URL` - –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞

### API Endpoints

- ‚ùå `GET /signals` - –ø–∞—Ä—Å–∏–Ω–≥ —Å–∏–≥–Ω–∞–ª–æ–≤ —É–¥–∞–ª–µ–Ω

## –ò–∑–º–µ–Ω–µ–Ω–æ

### `src/userbot.ts`

**–ë—ã–ª–æ:**

- –ü–æ–ª—É—á–∞–ª —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Telegram
- –ü–∞—Ä—Å–∏–ª —Å–∏–≥–Ω–∞–ª—ã —á–µ—Ä–µ–∑ `parseSignalMessage()`
- –°–æ—Ö—Ä–∞–Ω—è–ª –≤ –±–∞–∑—É —á–µ—Ä–µ–∑ `addSignal()`
- –í—ã–∑—ã–≤–∞–ª callback –¥–ª—è webhook

**–°—Ç–∞–ª–æ:**

- –ü–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Telegram
- –ü—É–±–ª–∏–∫—É–µ—Ç —Å—ã—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ NATS (`telega.message`)
- –ë–µ–∑ –ø–∞—Ä—Å–∏–Ω–≥–∞, –±–µ–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- –ü—Ä–æ—Å—Ç–æ–π —Ñ–æ—Ä–≤–∞—Ä–¥–µ—Ä

### `src/service.ts`

**–ë—ã–ª–æ:**

- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª PostgreSQL
- –†–∞–±–æ—Ç–∞–ª —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
- –ó–∞–∫—Ä—ã–≤–∞–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π

**–°—Ç–∞–ª–æ:**

- –¢–æ–ª—å–∫–æ Redis –∏ NATS
- –ù–∏–∫–∞–∫–æ–π —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π
- –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

### `src/index.ts`

**–ë—ã–ª–æ:**

- –≠–Ω–¥–ø–æ–∏–Ω—Ç `/signals` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤
- –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç PostgreSQL
- –ò–º–ø–æ—Ä—Ç `store.ts`

**–°—Ç–∞–ª–æ:**

- –£–±—Ä–∞–Ω `/signals`
- –¢–æ–ª—å–∫–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–∞–º–∏ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
- –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å —Ç–æ–ª—å–∫–æ –æ—Ç NATS –∏ Redis

### `package.json`

**–ë—ã–ª–æ:**

```json
{
  "dependencies": {
    "@aladdin/database": "workspace:*",
    "node-telegram-bot-api": "^0.61.0"
  }
}
```

**–°—Ç–∞–ª–æ:**

```json
{
  "dependencies": {
    "ioredis": "^5.3.2",
    "telegram": "^2.26.22"
  }
}
```

### `.env`

**–ë—ã–ª–æ:**

```bash
DATABASE_URL=postgres://...
TELEGRAM_CHANNEL_ID=...
```

**–°—Ç–∞–ª–æ:**

```bash
REDIS_URL=redis://...
NATS_URL=nats://...
# TELEGRAM_CHANNEL_ID –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω
```

## –î–æ–±–∞–≤–ª–µ–Ω–æ

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- ‚úÖ `README.md` - –Ω–æ–≤–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- ‚úÖ `NATS_INTEGRATION.md` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å NATS
- ‚úÖ `QUICKSTART.md` - –±—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
- ‚úÖ `REFACTORING_SUMMARY.md` - —ç—Ç–æ —Ñ–∞–π–ª
- ‚úÖ `.env.example` - –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –ø—Ä–∏–º–µ—Ä

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

- ‚úÖ –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ NATS —Ç–æ–ø–∏–∫ `telega.message`
- ‚úÖ REST API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ —á–µ—Ä–µ–∑ Redis
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–ø–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ë—ã–ª–æ

```
Telegram ‚Üí Telega ‚Üí Parse ‚Üí Database ‚Üí Webhook
                      ‚Üì
                   Signals
```

### –°—Ç–∞–ª–æ

```
Telegram ‚Üí Telega ‚Üí NATS ‚Üí [Any Service]
            ‚Üì                    ‚Üì
         Redis            Parse/Store/Analyze
```

## NATS Message Format

### –ë—ã–ª–æ (—á–µ—Ä–µ–∑ webhook)

```json
{
  "pair": "BTCUSDT",
  "timeframe": "1h",
  "entry": {...},
  "targets": [...],
  "stop_loss": 49000
}
```

### –°—Ç–∞–ª–æ (—Å—ã—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)

```json
{
  "channelId": "cryptosignalschannel",
  "messageId": 12345,
  "text": "üì© #BTCUSDT 1h | Short-Term...",
  "date": 1696411200,
  "views": 1234,
  "forwards": 10,
  "timestamp": 1696411200500
}
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### 1. –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

- Telega: —Ç–æ–ª—å–∫–æ –ø–æ–ª—É—á–µ–Ω–∏–µ –∏ –ø–µ—Ä–µ—Å—ã–ª–∫–∞
- –î—Ä—É–≥–∏–µ —Å–µ—Ä–≤–∏—Å—ã: –ø–∞—Ä—Å–∏–Ω–≥, –∞–Ω–∞–ª–∏–∑, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ

### 2. –ì–∏–±–∫–æ—Å—Ç—å

- –õ—é–±–æ–π —Å–µ—Ä–≤–∏—Å –º–æ–∂–µ—Ç –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ `telega.message`
- –ö–∞–∂–¥—ã–π –ø–∞—Ä—Å–∏—Ç/–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ-—Å–≤–æ–µ–º—É
- –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

### 3. –ü—Ä–æ—Å—Ç–æ—Ç–∞

- –ú–µ–Ω—å—à–µ –∫–æ–¥–∞
- –ú–µ–Ω—å—à–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- –ü—Ä–æ—â–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å

### 4. –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

- NATS –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç 10000+ msg/sec
- –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –±–µ–∑ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ Telega
- –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏

### 5. –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å

- –ï—Å–ª–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–ø–∞–ª - Telega –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- NATS –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è
- Redis —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ

## –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

### –ï—Å–ª–∏ —É –≤–∞—Å –±—ã–ª webhook

**–ë—ã–ª–æ:**

```typescript
app.post("/webhook/telega", async (req, res) => {
  const signal = req.body
  await processSignal(signal)
})
```

**–°—Ç–∞–ª–æ:**

```typescript
import { createNatsClient } from "@aladdin/shared/nats"

const nats = await createNatsClient()
await nats.subscribe("telega.message", async (message) => {
  const signal = parseSignal(message.text)
  if (signal) {
    await processSignal(signal)
  }
})
```

### –ï—Å–ª–∏ —á–∏—Ç–∞–ª–∏ –∏–∑ –±–∞–∑—ã

**–ë—ã–ª–æ:**

```typescript
const signals = await prisma.signal.findMany({
  where: { pair: "BTCUSDT" },
})
```

**–°—Ç–∞–ª–æ:**
–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π —Å–µ—Ä–≤–∏—Å, –∫–æ—Ç–æ—Ä—ã–π:

1. –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ `telega.message`
2. –ü–∞—Ä—Å–∏—Ç —Å–∏–≥–Ω–∞–ª—ã
3. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ —Å–≤–æ—é –±–∞–∑—É
4. –ß–∏—Ç–∞–µ—Ç –æ—Ç—Ç—É–¥–∞

## –ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ

### 1. –°–æ–∑–¥–∞—Ç—å Signal Parser Service

```typescript
// services/signal-parser/src/index.ts
import { createNatsClient } from "@aladdin/shared/nats"
import { parseSignal } from "./parser"
import { saveSignal } from "./database"

const nats = await createNatsClient()

await nats.subscribe("telega.message", async (message) => {
  const signal = parseSignal(message.text)
  if (signal) {
    await saveSignal({
      ...signal,
      source: message.channelId,
    })
  }
})
```

### 2. –°–æ–∑–¥–∞—Ç—å Analytics Service

```typescript
// services/analytics/src/index.ts
await nats.subscribe("telega.message", (message) => {
  metrics.increment(`messages.${message.channelId}`)

  if (isSignal(message.text)) {
    metrics.increment(`signals.${message.channelId}`)
  }
})
```

### 3. –°–æ–∑–¥–∞—Ç—å Notification Service

```typescript
// services/notifications/src/index.ts
await nats.subscribe("telega.message", async (message) => {
  if (isImportant(message.text)) {
    await sendNotification(message)
  }
})
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å Telega
cd apps/telega
bun run dev

# 2. –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª
curl -X POST http://localhost:3005/channels/subscribe \
  -d '{"channelId": "cryptosignalschannel"}'

# 3. –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ NATS (–≤ –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ)
nats sub telega.message

# 4. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–∞–Ω–∞–ª
# –î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å –≤ NATS CLI

# 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
curl http://localhost:3005/channels/cryptosignalschannel/messages?limit=5
```

## –ò—Ç–æ–≥–∏

‚úÖ Telega —Å—Ç–∞–ª –ø—Ä–æ—Å—Ç—ã–º —Ñ–æ—Ä–≤–∞—Ä–¥–µ—Ä–æ–º —Å–æ–æ–±—â–µ–Ω–∏–π  
‚úÖ –í—Å—è –ª–æ–≥–∏–∫–∞ –≤—ã–Ω–µ—Å–µ–Ω–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã  
‚úÖ NATS –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç pub/sub –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É  
‚úÖ Redis —Ö—Ä–∞–Ω–∏—Ç –ø–æ–¥–ø–∏—Å–∫–∏  
‚úÖ –ü—Ä–æ—Å—Ç–æ—Ç–∞, –≥–∏–±–∫–æ—Å—Ç—å, –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

–¢–µ–ø–µ—Ä—å Telega –¥–µ–ª–∞–µ—Ç –æ–¥–Ω—É –≤–µ—â—å –∏ –¥–µ–ª–∞–µ—Ç –µ—ë —Ö–æ—Ä–æ—à–æ: –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Telegram –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ NATS. –í—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ - –∑–∞–¥–∞—á–∞ –¥—Ä—É–≥–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤.
